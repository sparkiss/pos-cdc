  services:
    # Target MySQL 8
    mysql-target:
      image: mysql:8.0
      container_name: mysql-target
      restart: unless-stopped
      networks:
        - cdc-network
      ports:
        - "3307:3306"
      environment:
        MYSQL_ROOT_PASSWORD: ${TARGET_DB_PASSWORD}
        MYSQL_DATABASE: ${TARGET_DB_NAME}
        MYSQL_USER: ${TARGET_DB_USER}
        MYSQL_PASSWORD: ${TARGET_DB_PASSWORD}
      volumes:
        - mysql-target-data:/var/lib/mysql
      command:
        - --character-set-server=utf8mb4
        - --collation-server=utf8mb4_unicode_ci
        - --max_connections=500
        - --default-authentication-plugin=mysql_native_password

    # Redpanda (Kafka-compatible message broker)
    redpanda:
      image: docker.redpanda.com/redpandadata/redpanda:v25.2.11
      container_name: redpanda
      restart: unless-stopped
      networks:
        - cdc-network
      ports:
        - "9092:9092"   # Kafka API
        - "9644:9644"   # Admin API
      command:
        - redpanda
        - start
        - --smp
        - "1"
        - --reserve-memory
        - "0M"
        - --overprovisioned
        - --node-id
        - "0"
        - --kafka-addr
        - PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
        - --advertise-kafka-addr
        - PLAINTEXT://redpanda:29092,OUTSIDE://localhost:9092
      volumes:
        - redpanda-data:/var/lib/redpanda/data

    # Redpanda Console (Web UI)
    redpanda-console:
      image: docker.redpanda.com/redpandadata/console:latest
      container_name: redpanda-console
      restart: unless-stopped
      networks:
        - cdc-network
      ports:
        - "8080:8080"
      environment:
        KAFKA_BROKERS: redpanda:29092
      depends_on:
        - redpanda

    # Debezium (Kafka Connect with MySQL connector)
    debezium:
      image: debezium/connect:2.5
      container_name: debezium
      restart: unless-stopped
      networks:
        - cdc-network
      ports:
        - "8083:8083"
      environment:
        BOOTSTRAP_SERVERS: redpanda:29092
        GROUP_ID: debezium-cluster
        CONFIG_STORAGE_TOPIC: debezium_configs
        OFFSET_STORAGE_TOPIC: debezium_offsets
        STATUS_STORAGE_TOPIC: debezium_status
        CONNECT_REST_ADVERTISED_HOST_NAME: debezium
        CONNECT_PLUGIN_PATH: /kafka/connect
      depends_on:
        - redpanda
      volumes:
        - debezium-data:/kafka/data

  volumes:
    mysql-target-data:
    redpanda-data:
    debezium-data:

  networks:
    cdc-network:
      external: true


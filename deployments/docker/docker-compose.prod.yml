# Production environment overrides
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Note: Production uses external MySQL target database (not containerized)
# Configure TARGET_DB_HOST in .env.prod to point to the production MySQL 8 server

services:
  # CDC Consumer Application
  cdc-consumer:
    image: cdc-consumer:latest
    container_name: cdc-consumer
    restart: always
    networks:
      - cdc-network
    ports:
      - "8081:8081"   # Health check endpoint
      - "9090:9090"   # Metrics endpoint
    environment:
      # Kafka/Redpanda
      KAFKA_BROKERS: redpanda:29092
      KAFKA_GROUP_ID: ${KAFKA_GROUP_ID:-cdc-consumer-group}
      KAFKA_AUTO_OFFSET_RESET: ${KAFKA_AUTO_OFFSET_RESET:-earliest}

      # Target Database (external)
      TARGET_DB_HOST: ${TARGET_DB_HOST}
      TARGET_DB_PORT: ${TARGET_DB_PORT:-3306}
      TARGET_DB_USER: ${TARGET_DB_USER}
      TARGET_DB_PASSWORD: ${TARGET_DB_PASSWORD}
      TARGET_DB_NAME: ${TARGET_DB_NAME}

      # Timezone settings
      SOURCE_DB_TIMEZONE: ${SOURCE_DB_TIMEZONE:-UTC}
      TARGET_DB_TIMEZONE: ${TARGET_DB_TIMEZONE:-UTC}

      # Application settings
      WORKER_COUNT: ${WORKER_COUNT:-8}
      BATCH_SIZE: ${BATCH_SIZE:-100}
      MAX_RETRIES: ${MAX_RETRIES:-3}
      RETRY_BACKOFF_MS: ${RETRY_BACKOFF_MS:-1000}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      EXCLUDED_TABLES: ${EXCLUDED_TABLES:-}

      # Monitoring ports
      METRICS_PORT: 9090
      HEALTH_PORT: 8081
    depends_on:
      - redpanda
      - debezium
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        compress: "true"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: always
    networks:
      - cdc-network
    ports:
      - "9091:9090"
    volumes:
      - ./../../configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
        compress: "true"

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    networks:
      - cdc-network
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./../../configs/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
        compress: "true"

  # Production overrides for base services
  redpanda:
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        compress: "true"

  redpanda-console:
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
        compress: "true"

  debezium:
    restart: always
    environment:
      LOG_LEVEL: INFO
      KAFKA_HEAP_OPTS: "-Xms1G -Xmx2G"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        compress: "true"

  connect-ui:
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
        compress: "true"

volumes:
  prometheus-data:
  grafana-data:

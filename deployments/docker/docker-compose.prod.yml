# deployments/docker/docker-compose.prod.yml
# Production environment - NO mysql-target (uses external DB)

services:
  cdc-consumer:
    image: ghcr.io/sparkiss/pos-cdc-consumer:latest
    container_name: cdc-consumer
    restart: always
    networks:
      - cdc-network
    ports:
      - "9090:9090"  # Metrics
      - "8081:8081"  # Health
    environment:
      # Target Database Type
      TARGET_TYPE: ${TARGET_TYPE:-postgres}

      # Target Database - MySQL (used when TARGET_TYPE=mysql)
      TARGET_DB_HOST: ${TARGET_DB_HOST}
      TARGET_DB_PORT: ${TARGET_DB_PORT}
      TARGET_DB_USER: ${TARGET_DB_USER}
      TARGET_DB_PASSWORD: ${TARGET_DB_PASSWORD}
      TARGET_DB_NAME: ${TARGET_DB_NAME}

      # Target Database - PostgreSQL (used when TARGET_TYPE=postgres)
      TARGET_PG_HOST: ${TARGET_PG_HOST}
      TARGET_PG_PORT: ${TARGET_PG_PORT}
      TARGET_PG_USER: ${TARGET_PG_USER}
      TARGET_PG_PASSWORD: ${TARGET_PG_PASSWORD}
      TARGET_PG_DATABASE: ${TARGET_PG_DATABASE}
      TARGET_PG_SSLMODE: ${TARGET_PG_SSLMODE:-disable}

      # Kafka
      KAFKA_BROKERS: redpanda:29092
      KAFKA_GROUP_ID: cdc-consumer-group
      KAFKA_AUTO_OFFSET_RESET: earliest

      # Application
      LOG_LEVEL: info
      LOG_FORMAT: json
      WORKER_COUNT: 4
      BATCH_SIZE: 100
      MAX_RETRIES: 3
      RETRY_BACKOFF_MS: 1000
      EXCLUDED_TABLES: ${EXCLUDED_TABLES:-recorded_order,lock,log}

      # Timezone
      SOURCE_DB_TIMEZONE: ${SOURCE_DB_TIMEZONE:-America/Toronto}
      TARGET_DB_TIMEZONE: ${TARGET_DB_TIMEZONE:-America/Toronto}

      # Monitoring
      METRICS_PORT: 9090
      HEALTH_PORT: 8081
    depends_on:
      - redpanda
      - debezium
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        compress: "true"

  # Prometheus (Monitoring)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: always
    networks:
      - cdc-network
    ports:
      - "9091:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Grafana (Visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    networks:
      - cdc-network
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-clock-panel
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus

  redpanda:
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  debezium:
    restart: always
    environment:
      LOG_LEVEL: INFO
      KAFKA_HEAP_OPTS: "-Xms1G -Xmx2G"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  prometheus-data:
  grafana-data:

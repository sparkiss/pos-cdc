pipeline {
    agent any

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['staging', 'production'],
            description: 'Select deployment environment'
        )
        string(
            name: 'IMAGE_TAG',
            defaultValue: 'latest',
            description: 'Docker image tag to deploy'
        )
    }

    environment {
        // Deployment target
        IMAGE_NAME = 'pos-cdc-consumer'
        DEPLOY_USER = 'deployer'
        DEPLOY_HOST = '192.168.0.112'

        // Source Database
        SOURCE_DB_HOST = '192.168.0.74'
        SOURCE_DB_PORT = '3306'
        SOURCE_DB_USER = 'cdc_user'
        SOURCE_DB_NAME = 'pos'

        // Target Database
        TARGET_DB_HOST = '192.168.0.104'
        TARGET_DB_PORT = '3306'
        TARGET_DB_USER = 'cdc_writer'
        TARGET_DB_NAME = 'pos_replica'

        // Kafka/Redpanda
        KAFKA_BROKERS = 'localhost:9092'
        KAFKA_GROUP_ID = 'cdc-consumer-group'
        KAFKA_AUTO_OFFSET_RESET = 'earliest'

        // Application
        LOG_LEVEL = 'info'
        LOG_FORMAT = 'text'
        WORKER_COUNT = '4'
        BATCH_SIZE = '100'
        MAX_RETRIES = '3'
        RETRY_BACKOFF_MS = '1000'
        EXCLUDED_TABLES = 'recorded_order,lock,log,versioninfo'

        // Monitoring
        METRICS_PORT = '9090'
        HEALTH_PORT = '8081'

        // Timezone
        SOURCE_DB_TIMEZONE = 'America/Toronto'
        TARGET_DB_TIMEZONE = 'America/Toronto'

        // Debezium
        DEBEZIUM_SERVER_ID = '118331'
    }

    stages {
        stage('Validate') {
            steps {
                zulipSend(
                    stream: 'Jenkins',
                    topic: 'pos-cdc',
                    message: "ðŸš€ Deploy Started to ${params.ENVIRONMENT}: ${env.JOB_NAME} #${env.BUILD_NUMBER}\nURL: ${env.BUILD_URL}"
                )
                script {
                    if (params.ENVIRONMENT == 'production') {
                        input message: 'Deploy to PRODUCTION?', ok: 'Deploy'
                    }
                }
            }
        }

        stage('Deploy to Server') {
            steps {
                withCredentials([
                    string(credentialsId: 'source-db-password', variable: 'SOURCE_DB_PASSWORD'),
                    string(credentialsId: 'target-db-password', variable: 'TARGET_DB_PASSWORD'),
                    string(credentialsId: 'grafana-password', variable: 'GRAFANA_PASSWORD'),
                    string(credentialsId: 'ghcr-token', variable: 'GHCR_TOKEN')
                ]) {
                    sshagent(['cdc-server-ssh-key']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << ENDSSH
                                cd /opt/pos-cdc

                                # Pull latest code
                                git pull origin main

                                # Navigate to docker directory
                                cd deployments/docker

                                # Generate .env file from Jenkins environment
                                cat > .env << 'ENVEOF'
# Generated by Jenkins - Do not edit manually
COMPOSE_FILE=docker-compose.yml:docker-compose.prod.yml

# Source Database
SOURCE_DB_HOST=${SOURCE_DB_HOST}
SOURCE_DB_PORT=${SOURCE_DB_PORT}
SOURCE_DB_USER=${SOURCE_DB_USER}
SOURCE_DB_PASSWORD=${SOURCE_DB_PASSWORD}
SOURCE_DB_NAME=${SOURCE_DB_NAME}

# Target Database
TARGET_DB_HOST=${TARGET_DB_HOST}
TARGET_DB_PORT=${TARGET_DB_PORT}
TARGET_DB_USER=${TARGET_DB_USER}
TARGET_DB_PASSWORD=${TARGET_DB_PASSWORD}
TARGET_DB_NAME=${TARGET_DB_NAME}

# Kafka/Redpanda
KAFKA_BROKERS=${KAFKA_BROKERS}
KAFKA_GROUP_ID=${KAFKA_GROUP_ID}
KAFKA_AUTO_OFFSET_RESET=${KAFKA_AUTO_OFFSET_RESET}

# Application
LOG_LEVEL=${LOG_LEVEL}
LOG_FORMAT=${LOG_FORMAT}
WORKER_COUNT=${WORKER_COUNT}
BATCH_SIZE=${BATCH_SIZE}
MAX_RETRIES=${MAX_RETRIES}
RETRY_BACKOFF_MS=${RETRY_BACKOFF_MS}
EXCLUDED_TABLES=${EXCLUDED_TABLES}

# Monitoring
METRICS_PORT=${METRICS_PORT}
HEALTH_PORT=${HEALTH_PORT}

# Timezone
SOURCE_DB_TIMEZONE=${SOURCE_DB_TIMEZONE}
TARGET_DB_TIMEZONE=${TARGET_DB_TIMEZONE}

# Debezium
DEBEZIUM_SERVER_ID=${DEBEZIUM_SERVER_ID}

# Grafana
GRAFANA_PASSWORD=${GRAFANA_PASSWORD}
ENVEOF

                                # Login to GitHub Container Registry
                                echo "${GHCR_TOKEN}" | docker login ghcr.io -u sparkiss --password-stdin

                                # Pull latest Docker image
                                docker pull ghcr.io/sparkiss/${IMAGE_NAME}:${IMAGE_TAG}

                                # Restart CDC consumer
                                docker compose up -d --no-deps cdc-consumer

                                # Wait for health check
                                sleep 30

                                # Verify deployment
                                docker compose ps
                                curl -f http://localhost:${HEALTH_PORT}/health || exit 1

                                echo "Deployment successful!"
ENDSSH
                        """
                    }
                }
            }
        }

        stage('Health Check') {
            steps {
                script {
                    def healthy = false
                    for (int i = 0; i < 10; i++) {
                        try {
                            sshagent(['cdc-server-ssh-key']) {
                                sh """
                                    ssh \${DEPLOY_USER}@\${DEPLOY_HOST} 'curl -f http://localhost:8081/health'
                                """
                            }
                            healthy = true
                            break
                        } catch (Exception e) {
                            echo "Health check attempt ${i + 1} failed, retrying..."
                            sleep 10
                        }
                    }
                    if (!healthy) {
                        error "Health check failed after 10 attempts"
                    }
                }
            }
        }

        stage('Rollback on Failure') {
            when {
                expression { currentBuild.result == 'FAILURE' }
            }
            steps {
                sshagent(['cdc-server-ssh-key']) {
                    sh """
                        ssh \${DEPLOY_USER}@\${DEPLOY_HOST} << 'ENDSSH'
                            cd /opt/pos-cdc/deployments/docker

                            # Rollback to previous image
                            docker compose down cdc-consumer
                            docker pull ghcr.io/sparkiss/${IMAGE_NAME}:previous
                            docker tag ghcr.io/sparkiss/${IMAGE_NAME}:previous ghcr.io/sparkiss/${IMAGE_NAME}:latest
                            docker compose up -d cdc-consumer

                            echo "Rollback completed"
ENDSSH
                    """
                }
            }
        }
    }

    post {
        success {
            zulipSend(
                stream: 'Jenkins',
                topic: 'pos-cdc',
                message: "âœ… DEPLOYED to ${params.ENVIRONMENT}: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            )
        }
        failure {
            zulipSend(
                stream: 'Jenkins',
                topic: 'pos-cdc',
                message: "âŒ DEPLOYMENT FAILED to ${params.ENVIRONMENT}: ${env.JOB_NAME} #${env.BUILD_NUMBER}\nURL: ${env.BUILD_URL}"
            )
        }
    }
}
